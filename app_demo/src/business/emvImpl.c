#include "appinc.h"

#define HIGH_NIBBLE(theByte)	((theByte>>4)&0x0F)	//high half byte
#define LOW_NIBBLE(theByte)	(theByte&0x0F)			//Low half byte
#define PR_ARRAY_SIZE(x)	(sizeof(x)/sizeof(x[0]))

#define EXP_DATE_LENGTH			4
#define SERVICE_CODE_LENGTH		3

PR_UINT8 PR_Bcd2Dec(PR_UINT8 theBcdValue)
{
	return ((theBcdValue>>4)&(0x0F))*10 + (theBcdValue&(0x0F));
}

PR_BOOL CardDataIsNum(PR_INT8 Data){
	if(Data>='0'&&Data<='9')
		return PR_TRUE;
	else
		return PR_FALSE;
}

#define RID_LENGTH 5
const PR_INT8* s_CardCompany[] = {
    "CUP",
    "VIS",
    "MCC",
    "JCB",
    "DCC",
    "AMX",
};

const PR_INT8 s_RidList[][RID_LENGTH] = {
    {0xA0, 0x00, 0x00, 0x03, 0x33},
    {0xA0, 0x00, 0x00, 0x00, 0x03},
    {0xA0, 0x00, 0x00, 0x00, 0x04},
    {0xA0, 0x00, 0x00, 0x00, 0x65},
    {0xA0, 0x00, 0x00, 0x00, 0x31},
    {0xA0, 0x00, 0x00, 0x00, 0x25},
};

PR_Bool GetIccCardCompany(PR_INT8* theCompany)
{
	PR_UINT8* rid = 0;
	PR_INT32 length = 0;
	PR_Bool getCardCompanyOk = PR_FALSE;

	rid = Emv_GetCoreData(EMVTAG_AID, &length);
	if (rid && (length>=RID_LENGTH))
	{
		PR_INT32 i=0;

		for(; i<PR_ARRAY_SIZE(s_RidList); i++)
		{
			if (memcmp(s_RidList[i], rid, RID_LENGTH) == 0)
			{
				strcpy(theCompany, s_CardCompany[i]);
				getCardCompanyOk = PR_TRUE;
			}
		}
	}

	return getCardCompanyOk;
}

//Multiple application selection return value>=0. Return selected AID serial number -1 failed
int aidSelect(AidCandidate_t *pList, int listNum){

	unpackAppsName(listNum,pList);
	event_ui_register(UI_MULTI_APP_SELECT);
	get_transaction_data()->emv_multi_app_select_result = 0xFF;
	while(get_transaction_data()->emv_multi_app_select_result == 0xFF)
	{
		OsSleep(100);
	}
	event_ui_register(UI_READ_ICCARD);
    return get_transaction_data()->emv_multi_app_select_result;
}
//Card number confirmation return value 0 Confirm-1 failed
int confirmCardInfo(char *pan,int len){
	OsLog(LOG_DEBUG,"confirmCardInfo [%s]",pan);
	memcpy(get_transaction_data()->sCardNo,pan,len);
    return 0;
}

int Emv_GetPanByTag5A(char* pan){
	int len = 0;
	unsigned char *value = NULL;
	char sepflag = 0;
	char *p = NULL;
	char szPan[32];

	if(pan == NULL){
		return -1;
	}
	value = Emv_GetCoreData(0x5A, &len);
	OsLog(LOG_DEBUG,"5A Len[%d]",len);
	if(!value || len < 0){
		value = Emv_GetCoreData(0x57, &len);
		sepflag = 1;
		OsLog(LOG_DEBUG,"5A Len[%d]",len);
	}
	if(len > 0){
		memset(szPan,0,sizeof(szPan));
		PR_nUtilBcd2Asc(len,(char *)value, 0,sizeof(szPan), szPan);
		OsLog(LOG_DEBUG,"szPan1 [%s]",szPan);
		p = strstr(szPan,"D");
		if(p){
			*p = 0x00;
		}
		OsLog(LOG_DEBUG,"szPan2 [%s]",szPan);
		strcpy(pan,szPan);
		return 0;
	}
	OsLog(LOG_DEBUG,"Emv_GetPanByTag5A Failed");
	return -1;
}

extern void disp_mask_pin(int pinLen);

int inputPasswd(int type, char *pszPin){
	int ret ;
	unsigned char pinKsn[16] = {0};
	
	if(type == EMV_ONLINEPIN_INPUT)
	{
		get_transaction_data()->emv_emter_online_pin_result =0xFF;
		event_ui_register(UI_ENTER_ONLINE_PIN);
		ret = OsPedOpen();
		if(ret != RET_OK)
		{
			return PR_FAILD;
		}

		ret = OsPedIncreaseKsnDukpt(PED_PIN_IPEK_INDEX);
		if(ret != RET_OK){
			OsCloseSoftKeyboard ();
			return PR_FAILD;
		}
		ret = OsPedGetPinBlockDukptBySoftKeyboard(PED_PIN_IPEK_INDEX,get_transaction_data()->sCardNo, 4, 6, 60*1000,pinKsn, pszPin,disp_mask_pin);
		OsLog(LOG_DEBUG,"--------OsPedGetPinBlockDukptBySoftKeyboard ret = %d",ret);
		OsCloseSoftKeyboard ();
		if(ret == RET_OK)
		{
			get_transaction_data()->emv_emter_online_pin_result = 1;
			memcpy(get_transaction_data()->sPin,pszPin,8);
			memcpy(get_transaction_data()->sPinKsn,pinKsn,strlen(pinKsn));
		}
	}
	else
	{
		event_ui_register(UI_ENTER_OFFLINE_PIN);
		get_transaction_data()->emv_enter_offline_pin_result = 0xFF;
		while(get_transaction_data()->emv_enter_offline_pin_result == 0xFF)
		{
			OsSleep(100);
		}
	
		if(get_transaction_data()->emv_enter_offline_pin_result == 0) //offline pin enter
		{
			memcpy(pszPin,get_transaction_data()->sPin,strlen(get_transaction_data()->sPin));
			ret = strlen(get_transaction_data()->sPin);
		}
		else
		{
			ret = -1;
		}
	}
    return ret;
}

PR_BOOL Emv_ParseTrack2(TransactionData *pEmvTransData)
{
	PR_UINT32 i=0;
	PR_UINT32 cardNumLength = 0;

	if(pEmvTransData->nTracker2Len <= 0){
		return PR_FALSE;
	}
	for( ;i<pEmvTransData->nTracker2Len; i++)
	{
		if(CardDataIsNum(pEmvTransData->sTracker2[i])==PR_FALSE)
		{
			// The card number starts from the starting character (1 byte) and ends with the delimiter
			#define SIZE_OF_START_FLAG 0
			cardNumLength = i-SIZE_OF_START_FLAG;	
			if(strlen(pEmvTransData->sCardNo) <= 0){
				memcpy(pEmvTransData->sCardNo, pEmvTransData->sTracker2+SIZE_OF_START_FLAG, cardNumLength);
			}
			
			memcpy(pEmvTransData->sExpDate, pEmvTransData->sTracker2+i+1, EXP_DATE_LENGTH);
			memcpy(pEmvTransData->sServiceCode, pEmvTransData->sTracker2+i+1+EXP_DATE_LENGTH, SERVICE_CODE_LENGTH);
			break;
		}
	}

	return PR_TRUE;
}


PR_INT32 Emv_GetCardInfo(TransactionData *pEmvTransData){
	PR_UINT8* value = PR_NULL;
	PR_INT32 length = 0;
	PR_INT32 rawLength = 0;
	PR_Bool havePanTag;
	PR_UINT8 buf[256];

	value = Emv_GetCoreData(EMVTAG_APP_PAN_SN, &length);
	if (value){
		sprintf((PR_INT8*)pEmvTransData->sCardSN, "%03d", PR_Bcd2Dec(*value));
	}
	//TRACK2 DATA
	value = Emv_GetCoreData(EMVTAG_TRACK2, &length);
	if (value){
		//Determine if there is an additional right complement F
		PR_INT32 i;
		PR_INT32 offset = 0;
		for (i=0; i<length; i++){
			PR_UINT8 hinibble;
			PR_UINT8 lonibble;

			hinibble = HIGH_NIBBLE(value[i]);
			lonibble = LOW_NIBBLE(value[i]);
			if(hinibble== 0x0d){
				offset = i*2;
			}else if(lonibble==0x0d){
				offset = i*2+1;
			}
		}
		rawLength = (LOW_NIBBLE(value[length-1]) == 0xF) ? 2*length-1 : 2*length;
		if(PR_FAILD == PR_nUtilHex2Asc(length,value,PR_ARRAY_SIZE(buf), (char*)buf)){
			return PR_FAILD;
		}
		strcpy((PR_INT8*)pEmvTransData->sTracker2, (PR_INT8*)buf);
		// A regular magnetic stripe card is'='; Equivalent data bit 'D' of IC card, uniformly converted to '=';
		if (offset > 0){
			pEmvTransData->sTracker2[offset] = '=';
		}
		pEmvTransData->nTracker2Len = rawLength;
		// Obtain relevant data from equivalent 2 magnets.
		Emv_ParseTrack2(pEmvTransData);
		value = Emv_GetCoreData(EMVTAG_APP_EXPDATA, &length);
		if(value)
		{
			PR_INT8 acExpDate[EXP_DATE_LENGTH+1] = {0};
			PR_INT32 nAscLen = 0;
			nAscLen = PR_nUtilBcd2Asc(2,(PR_INT8*)value,EM_ALIGN_LEFT,sizeof(acExpDate),acExpDate);
			memcpy((PR_INT8*)pEmvTransData->sExpDate,acExpDate,nAscLen);
		}
	}
	if (PR_FALSE==GetIccCardCompany((PR_INT8*)pEmvTransData->sCardCompany))
	{
		strcpy((PR_INT8*)pEmvTransData->sCardCompany, "000");
	}
	return PR_NORMAL;
}

PR_INT32 Pack_EmvData(PR_UINT8* pEmvData,PR_INT32 *pEmvDataLen)
{
	PR_UINT8 buf[512];
	PR_UINT32 totalLength;
	PR_UINT32 tags[] = {EMVTAG_AC, EMVTAG_CID, EMVTAG_IAD, EMVTAG_RND_NUM,
						EMVTAG_ATC, EMVTAG_TVR, EMVTAG_TXN_DATE, EMVTAG_TXN_TYPE,
						EMVTAG_AMOUNT, EMVTAG_CURRENCY, EMVTAG_AIP, EMVTAG_COUNTRY_CODE,
						EMVTAG_OTHER_AMOUNT, EMVTAG_TERM_CAP, EMVTAG_CVM, EMVTAG_TERM_TYPE,
						EMVTAG_IFD, EMVTAG_DF, EMVTAG_APP_VER, EMVTAG_TXN_SN,
						EMVTAG_CARD_ID, EMVTAG_ARC, EMVTAG_EC_AUTH_CODE};
	totalLength = Emv_FetchData(tags, PR_ARRAY_SIZE(tags), buf, PR_ARRAY_SIZE(buf));

	nBcd2Asc(buf,totalLength*2,pEmvData,0);
	//memcpy(pEmvData,buf,totalLength);
	*pEmvDataLen = totalLength*2;
	
	return PR_NORMAL;
}

int onlineProcess(EmvOnlineData_t* pOnlineData){
	event_ui_register(UI_PROCESSING);
	Emv_GetCardInfo(get_transaction_data());
	sale_online_request(pOnlineData);
    return PR_NORMAL;
}

int certConfirm(unsigned char type, unsigned char *pcon, unsigned char len){
    return 1;
}

int emv_process_disp(EmvKernelDisp type)
{

	switch (type)
	{
	case EMV_DISP_READING_CARD:
		event_ui_register(UI_READ_ICCARD);
		break;
	case EMV_DISP_SEE_PHONE:
		event_ui_register(UI_SEE_PHONE);
		OsSleep(5000);
		break;
	case EMV_DISP_REMOVE_CARD:
		event_ui_register(UI_REMOVE_CARD);
		break;
	case EMV_DISP_NFC_RETAP:
		event_ui_register(UI_NFC_RETAP);
		break;
	default:
		break;
	}
	return 0;
} 

static void Initialize_EMV_TermConfig(EmvTermConfig_t *ptermconfig)
{
	int nStatus = 0;

	// ptermconfig->_type = 0x22;
	// memcpy(ptermconfig->_cap,"\x60""\xE9""\xC8", 3);
	// memcpy(ptermconfig->_add_cap,"\xFF""\x80""\xF0""\xF0""\x01", 5);
	// memcpy(ptermconfig->_ics,"\xF4""\xF0""\xF0""\xF8""\xAF""\xFE""\x80""\x00", 8);
	// memcpy(ptermconfig->_ifd_serial_num,"8320ICC", 8);
	// memcpy(ptermconfig->_term_country_code,"\x01""\x56", 2);
	// memcpy(ptermconfig->_terminal_id,"12345678", 8);
	// memcpy(ptermconfig->_trans_curr_code,"\x01""\x56", 2);
	// ptermconfig->_trans_curr_exp = 0x00;
	// memcpy(ptermconfig->_merchant_name,"test", 4);
}

static void Initialize_EMV_CallBackFun(EmvCallBack_t *pcallbackfun)
{
	pcallbackfun->EMV_AidSelect = aidSelect;
	pcallbackfun->EMV_ConfirmCardInfo = confirmCardInfo;
	pcallbackfun->EMV_InputPasswd = inputPasswd;
	pcallbackfun->EMV_CertConfirm = certConfirm;
	pcallbackfun->EMV_ProcessDisp = emv_process_disp;
	pcallbackfun->EMV_OnlineProcess = onlineProcess;
}

PR_INT32 EmvL2_Init(){
    EmvTermConfig_t termconfig;
    EmvCallBack_t t_callbackfun;

    Initialize_EMV_CallBackFun(&t_callbackfun);
    Initialize_EMV_TermConfig(&termconfig);
    if(Emv_KernelInit(termconfig,t_callbackfun) < 0){
        OsLog(LOG_DEBUG,"emv init fail\n");
        return PR_FAILD;
    }
    return PR_NORMAL;
}

PR_INT32 EmvL2_Proc(EmvTransParams_t emvTransParams){
    EMV_L2_Return nEmvRet = APP_RC_START;

    nEmvRet = Emv_Process(emvTransParams);
    return nEmvRet;
}

void EmvL2_SetDefaultAidAndCapk(){
    PR_UINT8 temp[1024];
	char *aidList[] = {
		"9F0608A000000333010101DF0101009F08020020DF1105FC78FCF8F0DF1205FC78FCF8F0DF130500100000009F1B04000186A0DF150400000028DF160150DF170120DF14039F3704DF180101DF2006000099999999DF2106000000100000DF19060000000300009F7B06000000030000",
		"9F0608A000000333010102DF0101009F08020020DF1105FC78FCF8F0DF1205FC78FCF8F0DF130500100000009F1B04000186A0DF150400000028DF160150DF170120DF14039F3704DF180101DF2006000099999999DF2106000000100000DF19060000000300009F7B06000000030000",
		"9F0608A000000333010103DF0101009F08020020DF1105FC78FCF8F0DF1205FC78FCF8F0DF130500100000009F1B04000186A0DF150400000028DF160150DF170120DF14039F3704DF180101DF2006000099999999DF2106000000100000DF19060000000300009F7B06000000030000",
		"9F0608A000000333010106DF0101009F08020020DF1105FC78FCF8F0DF1205FC78FCF8F0DF130500100000009F1B04000186A0DF150400000028DF160150DF170120DF14039F3704DF180101DF2006000099999999DF2106000000100000DF19060000000300009F7B06000000030000",
		"9F0607A0000003330101DF0101019F08020020DF1105FC50A82000DF1205F850A8F800DF130504000000009F1B04000186A0DF150400004000DF160150DF170120DF14039F3704DF180101DF2006000099999999DF2106000000100000DF19060000000400009F7B06000000010000",
		"9F0607A0000000031010DF0101009F08020140DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801019F7B06000000100000DF1906000000000000DF2006000000100000DF2106000000012000",
		"9F0606A00000079001DF0101019F08020030DF14039F3704DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF180101DF1906000000000000DF2006000000100000DF21060000000000009F7B06000000000000",
		"9F0607A0000000108888DF0101009F08020002DF1105FE509C8000DF1205FE509C8000DF130500000000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801019F7B06000000000000DF1906000000000000DF2006999999999999DF21060000001000009F66047F800000",
		"9F0606A00000002501DF010100DF1105CC00000000DF1205CC00000000DF130500000000009F08020001DF14039F3704DF170110DF150400000000DF1601259F1B0400000000DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000000000",
		"9F0607A0000000031010DF0101009F08020140DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000012000",
		"9F0607A0000000032010DF0101009F08020140DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000012000",
		"9F0607A0000000033010DF0101009F08020140DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000012000",
		"9F0607A0000000041010DF0101009F08020002DF1105FC5080A000DF1205F85080F800DF130504000000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000012000DF812406000099999999",  //JCB需增加DF8124非接限额
		"9F0607A0000000043060DF0101009F08020002DF1105FC5058A000DF1205F85058F800DF130504000000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000012000DF812406000099999999",  //JCB需增加DF8124非接限额
		"9F0607A0000000651010DF0101009F08020200DF1105FC6024A800DF1205FC60ACF800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000000000",
		"9F0607A0000001523010DF0101009F08020001DF1105D84000A800DF1205D84004F800DF130500100000009F1B0400000000DF150400000000DF160199DF170199DF14039F3704DF1801009F7B06000000000000DF1906000000000000DF2006999999999999DF2106000000000000",
		"9F0607A0000000250104DF0101009F08020001DF1105DC50FC9800DF1205DE00FC9800DF130500100000009F1B0400000000DF150400000000DF160110DF170110DF14039F3704DF180100DF2006999999999999DF2106000000000000DF19060000000000009F7B06000000000000",
		"9F0607A0000000250108DF0101009F08020001DF1105DC50FC9800DF1205DE00FC9800DF130500100000009F1B0400000000DF150400000000DF160110DF170110DF14039F3704DF180100DF2006999999999999DF2106000000000000DF19060000000000009F7B06000000000000",
		"9F0607A0000000250109DF0101009F08020001DF1105DC50FC9800DF1205DE00FC9800DF130500100000009F1B0400000000DF150400000000DF160110DF170110DF14039F3704DF180100DF2006999999999999DF2106000000000000DF19060000000000009F7B06000000000000",
		"9F0607A0000000250110DF0101009F08020001DF1105DC50FC9800DF1205DE00FC9800DF130500100000009F1B0400000000DF150400000000DF160110DF170110DF14039F3704DF180100DF2006999999999999DF2106000000000000DF19060000000000009F7B06000000000000"
	};
	int aidListCount = sizeof(aidList) / sizeof(aidList[0]);

	char *capkList[] = {
	"9F0605A0000003339F220102DF050420211230DF060101DF070101DF028190A3767ABD1B6AA69D7F3FBF28C092DE9ED1E658BA5F0909AF7A1CCD907373B7210FDEB16287BA8E78E1529F443976FD27F991EC67D95E5F4E96B127CAB2396A94D6E45CDA44CA4C4867570D6B07542F8D4BF9FF97975DB9891515E66F525D2B3CBEB6D662BFB6C3F338E93B02142BFC44173A3764C56AADD202075B26DC2F9F7D7AE74BD7D00FD05EE430032663D27A57DF040103DF031403BB335A8549A03B87AB089D006F60852E4B8060",
	"9F0605A0000003339F220103DF050420231230DF060101DF070101DF0281B0B0627DEE87864F9C18C13B9A1F025448BF13C58380C91F4CEBA9F9BCB214FF8414E9B59D6ABA10F941C7331768F47B2127907D857FA39AAF8CE02045DD01619D689EE731C551159BE7EB2D51A372FF56B556E5CB2FDE36E23073A44CA215D6C26CA68847B388E39520E0026E62294B557D6470440CA0AEFC9438C923AEC9B2098D6D3A1AF5E8B1DE36F4B53040109D89B77CAFAF70C26C601ABDF59EEC0FDC8A99089140CD2E817E335175B03B7AA33DDF040103DF031487F0CD7C0E86F38F89A66F8C47071A8B88586F26",
	"9F0605A0000003339F220104DF050420231230DF060101DF070101DF0281F8BC853E6B5365E89E7EE9317C94B02D0ABB0DBD91C05A224A2554AA29ED9FCB9D86EB9CCBB322A57811F86188AAC7351C72BD9EF196C5A01ACEF7A4EB0D2AD63D9E6AC2E7836547CB1595C68BCBAFD0F6728760F3A7CA7B97301B7E0220184EFC4F653008D93CE098C0D93B45201096D1ADFF4CF1F9FC02AF759DA27CD6DFD6D789B099F16F378B6100334E63F3D35F3251A5EC78693731F5233519CDB380F5AB8C0F02728E91D469ABD0EAE0D93B1CC66CE127B29C7D77441A49D09FCA5D6D9762FC74C31BB506C8BAE3C79AD6C2578775B95956B5370D1D0519E37906B384736233251E8F09AD79DFBE2C6ABFADAC8E4D8624318C27DAF1DF040103DF0314F527081CF371DD7E1FD4FA414A665036E0F5E6E5",
	"9F0605A0000007909F220120DF05083230333031323331DF060101DF070101DF0281F8BE22F59512B57941E30A6272FA6283B775B53C828C4AFE9B71E777D1E708F5A7A5FCC883D0E67E6CD5AB6C7DECE9F9EF5490A7C9C9D8DD66BEBCF088EA1EDEDBDE3A20F44D372E8C62E56B7362A2C55E0481A424EE2BB476CE11CEC1F25B78FAA4151A7D1F52EA2FF43BD684049716F043B830F0A318EC5ACD14D24078CE50057E4219447F0BECFA12E40FD0991DA8266D85DEBDAF2ECF919F1BEC467B4DCC50483BA945AD0BC2F4FC1D11FA4AC1DBFFC3F51C7406E0551F6C8E5410BAC60E94B4D6D22750D17E7D7182086F2646A6288AB0B1AA79EB49EA082DD21E8B0CE49ED60744051B5190D5836C4608B0E2259FAB39D69BE95391B3DF040103DF03147540CA9050EF1316A9D3DD64456248122CDE0C2D",
	"9F0605A0000007909F220128DF05083230333031323331DF060107DF070104DF0240DAA2C6F60A78FBA2560DFA4BE7550BF7A644DA80C057744CE73C7E342BC6FCC4781EC438D42DDD1FF0B2BA3EFE6873CFB7CB33F15179B18DFED34BCD9E01DF07DF040111DF0320FAA4AEF9B06590AB79BA0FD2A484416E456B37A1BB9C5789213F58DA2CC5A7ED",
	"9F0605A0000000259F22010EDF05083230323831323331DF060101DF070101DF028190AA94A8C6DAD24F9BA56A27C09B01020819568B81A026BE9FD0A3416CA9A71166ED5084ED91CED47DD457DB7E6CBCD53E560BC5DF48ABC380993B6D549F5196CFA77DFB20A0296188E969A2772E8C4141665F8BB2516BA2C7B5FC91F8DA04E8D512EB0F6411516FB86FC021CE7E969DA94D33937909A53A57F907C40C22009DA7532CB3BE509AE173B39AD6A01BA5BB85DF040103DF0314A7266ABAE64B42A3668851191D49856E17F8FBCD",
	"9F0605A0000000259F22010FDF05083230323831323331DF060101DF070101DF0281B0C8D5AC27A5E1FB89978C7C6479AF993AB3800EB243996FBB2AE26B67B23AC482C4B746005A51AFA7D2D83E894F591A2357B30F85B85627FF15DA12290F70F05766552BA11AD34B7109FA49DE29DCB0109670875A17EA95549E92347B948AA1F045756DE56B707E3863E59A6CBE99C1272EF65FB66CBB4CFF070F36029DD76218B21242645B51CA752AF37E70BE1A84FF31079DC0048E928883EC4FADD497A719385C2BBBEBC5A66AA5E5655D18034EC5DF040103DF0314A73472B3AB557493A9BC2179CC8014053B12BAB4",
	"9F0605A0000000259F220110DF05083230323931323331DF060101DF070101DF0281F8CF98DFEDB3D3727965EE7797723355E0751C81D2D3DF4D18EBAB9FB9D49F38C8C4A826B99DC9DEA3F01043D4BF22AC3550E2962A59639B1332156422F788B9C16D40135EFD1BA94147750575E636B6EBC618734C91C1D1BF3EDC2A46A43901668E0FFC136774080E888044F6A1E65DC9AAA8928DACBEB0DB55EA3514686C6A732CEF55EE27CF877F110652694A0E3484C855D882AE191674E25C296205BBB599455176FDD7BBC549F27BA5FE35336F7E29E68D783973199436633C67EE5A680F05160ED12D1665EC83D1997F10FD05BBDBF9433E8F797AEE3E9F02A34228ACE927ABE62B8B9281AD08D3DF5C7379685045D7BA5FCDE58637DF040103DF0314C729CF2FD262394ABC4CC173506502446AA9B9FD",
	"9F0605A0000000039F220107DF050420171231DF060101DF070101DF028190A89F25A56FA6DA258C8CA8B40427D927B4A1EB4D7EA326BBB12F97DED70AE5E4480FC9C5E8A972177110A1CC318D06D2F8F5C4844AC5FA79A4DC470BB11ED635699C17081B90F1B984F12E92C1C529276D8AF8EC7F28492097D8CD5BECEA16FE4088F6CFAB4A1B42328A1B996F9278B0B7E3311CA5EF856C2F888474B83612A82E4E00D0CD4069A6783140433D50725FDF040103DF0314B4BC56CC4E88324932CBC643D6898F6FE593B172",
	"9F0605A0000000039F220108DF050420241231DF060101DF070101DF0281B0D9FD6ED75D51D0E30664BD157023EAA1FFA871E4DA65672B863D255E81E137A51DE4F72BCC9E44ACE12127F87E263D3AF9DD9CF35CA4A7B01E907000BA85D24954C2FCA3074825DDD4C0C8F186CB020F683E02F2DEAD3969133F06F7845166ACEB57CA0FC2603445469811D293BFEFBAFAB57631B3DD91E796BF850A25012F1AE38F05AA5C4D6D03B1DC2E568612785938BBC9B3CD3A910C1DA55A5A9218ACE0F7A21287752682F15832A678D6E1ED0BDF040103DF031420D213126955DE205ADC2FD2822BD22DE21CF9A8",
	"9F0605A0000000039F220109DF050420261231DF060101DF070101DF0281F89D912248DE0A4E39C1A7DDE3F6D2588992C1A4095AFBD1824D1BA74847F2BC4926D2EFD904B4B54954CD189A54C5D1179654F8F9B0D2AB5F0357EB642FEDA95D3912C6576945FAB897E7062CAA44A4AA06B8FE6E3DBA18AF6AE3738E30429EE9BE03427C9D64F695FA8CAB4BFE376853EA34AD1D76BFCAD15908C077FFE6DC5521ECEF5D278A96E26F57359FFAEDA19434B937F1AD999DC5C41EB11935B44C18100E857F431A4A5A6BB65114F174C2D7B59FDF237D6BB1DD0916E644D709DED56481477C75D95CDD68254615F7740EC07F330AC5D67BCD75BF23D28A140826C026DBDE971A37CD3EF9B8DF644AC385010501EFC6509D7A41DF040103DF03141FF80A40173F52D7D27E0F26A146A1C8CCB29046",
	"9F0605A0000000039F220194DF050420181231DF060101DF070101DF0281F8ACD2B12302EE644F3F835ABD1FC7A6F62CCE48FFEC622AA8EF062BEF6FB8BA8BC68BBF6AB5870EED579BC3973E121303D34841A796D6DCBC41DBF9E52C4609795C0CCF7EE86FA1D5CB041071ED2C51D2202F63F1156C58A92D38BC60BDF424E1776E2BC9648078A03B36FB554375FC53D57C73F5160EA59F3AFC5398EC7B67758D65C9BFF7828B6B82D4BE124A416AB7301914311EA462C19F771F31B3B57336000DFF732D3B83DE07052D730354D297BEC72871DCCF0E193F171ABA27EE464C6A97690943D59BDABB2A27EB71CEEBDAFA1176046478FD62FEC452D5CA393296530AA3F41927ADFE434A2DF2AE3054F8840657A26E0FC617DF040103DF0314C4A3C43CCF87327D136B804160E47D43B60E6E0F",
	"9F0605A0000000039F220192DF050420181231DF060101DF070101DF0281B0996AF56F569187D09293C14810450ED8EE3357397B18A2458EFAA92DA3B6DF6514EC060195318FD43BE9B8F0CC669E3F844057CBDDF8BDA191BB64473BC8DC9A730DB8F6B4EDE3924186FFD9B8C7735789C23A36BA0B8AF65372EB57EA5D89E7D14E9C7B6B557460F10885DA16AC923F15AF3758F0F03EBD3C5C2C949CBA306DB44E6A2C076C5F67E281D7EF56785DC4D75945E491F01918800A9E2DC66F60080566CE0DAF8D17EAD46AD8E30A247C9FDF040103DF0314429C954A3859CEF91295F663C963E582ED6EB253",
	"9F0605A0000000039F220195DF050420171231DF060101DF070101DF028190BE9E1FA5E9A803852999C4AB432DB28600DCD9DAB76DFAAA47355A0FE37B1508AC6BF38860D3C6C2E5B12A3CAAF2A7005A7241EBAA7771112C74CF9A0634652FBCA0E5980C54A64761EA101A114E0F0B5572ADD57D010B7C9C887E104CA4EE1272DA66D997B9A90B5A6D624AB6C57E73C8F919000EB5F684898EF8C3DBEFB330C62660BED88EA78E909AFF05F6DA627BDF040103DF0314EE1511CEC71020A9B90443B37B1D5F6E703030F6",
	"9F0605A0000000049F220104DF050420171231DF060101DF070101DF028190A6DA428387A502D7DDFB7A74D3F412BE762627197B25435B7A81716A700157DDD06F7CC99D6CA28C2470527E2C03616B9C59217357C2674F583B3BA5C7DCF2838692D023E3562420B4615C439CA97C44DC9A249CFCE7B3BFB22F68228C3AF13329AA4A613CF8DD853502373D62E49AB256D2BC17120E54AEDCED6D96A4287ACC5C04677D4A5A320DB8BEE2F775E5FEC5DF040103DF0314381A035DA58B482EE2AF75F4C3F2CA469BA4AA6C",
	"9F0605A0000000049F220105DF050420241231DF060101DF070101DF0281B0B8048ABC30C90D976336543E3FD7091C8FE4800DF820ED55E7E94813ED00555B573FECA3D84AF6131A651D66CFF4284FB13B635EDD0EE40176D8BF04B7FD1C7BACF9AC7327DFAA8AA72D10DB3B8E70B2DDD811CB4196525EA386ACC33C0D9D4575916469C4E4F53E8E1C912CC618CB22DDE7C3568E90022E6BBA770202E4522A2DD623D180E215BD1D1507FE3DC90CA310D27B3EFCCD8F83DE3052CAD1E48938C68D095AAC91B5F37E28BB49EC7ED597DF040103DF0314EBFA0D5D06D8CE702DA3EAE890701D45E274C845",
	"9F0605A0000000049F220106DF050420241231DF060101DF070101DF0281F8CB26FC830B43785B2BCE37C81ED334622F9622F4C89AAE641046B2353433883F307FB7C974162DA72F7A4EC75D9D657336865B8D3023D3D645667625C9A07A6B7A137CF0C64198AE38FC238006FB2603F41F4F3BB9DA1347270F2F5D8C606E420958C5F7D50A71DE30142F70DE468889B5E3A08695B938A50FC980393A9CBCE44AD2D64F630BB33AD3F5F5FD495D31F37818C1D94071342E07F1BEC2194F6035BA5DED3936500EB82DFDA6E8AFB655B1EF3D0D7EBF86B66DD9F29F6B1D324FE8B26CE38AB2013DD13F611E7A594D675C4432350EA244CC34F3873CBA06592987A1D7E852ADC22EF5A2EE28132031E48F74037E3B34AB747FDF040103DF0314F910A1504D5FFB793D94F3B500765E1ABCAD72D9",
	"9F0605A0000000259F220104DF050420181231DF060101DF070101DF028160D0F543F03F2517133EF2BA4A1104486758630DCFE3A883C77B4E4844E39A9BD6360D23E6644E1E071F196DDF2E4A68B4A3D93D14268D7240F6A14F0D714C17827D279D192E88931AF7300727AE9DA80A3F0E366AEBA61778171737989E1EE309DF040103DF0314FDD7139EC7E0C33167FD61AD3CADBD68D66E91C5",
	"9F0605A0000000259F220165DF050420181231DF060101DF070101DF028190E53EB41F839DDFB474F272CD0CBE373D5468EB3F50F39C95BDF4D39FA82B98DABC9476B6EA350C0DCE1CD92075D8C44D1E57283190F96B3537D9E632C461815EBD2BAF36891DF6BFB1D30FA0B752C43DCA0257D35DFF4CCFC98F84198D5152EC61D7B5F74BD09383BD0E2AA42298FFB02F0D79ADB70D72243EE537F75536A8A8DF962582E9E6812F3A0BE02A4365400DDF040103DF0314894C5D08D4EA28BB79DC46CEAD998B877322F416",
	"9F0605A0000000659F220110DF050420171231DF060101DF070101DF02819099B63464EE0B4957E4FD23BF923D12B61469B8FFF8814346B2ED6A780F8988EA9CF0433BC1E655F05EFA66D0C98098F25B659D7A25B8478A36E489760D071F54CDF7416948ED733D816349DA2AADDA227EE45936203CBF628CD033AABA5E5A6E4AE37FBACB4611B4113ED427529C636F6C3304F8ABDD6D9AD660516AE87F7F2DDF1D2FA44C164727E56BBC9BA23C0285DF040103DF0314C75E5210CBE6E8F0594A0F1911B07418CADB5BAB",
	"9F0605A0000000659F220112DF050420241231DF060101DF070101DF0281B0ADF05CD4C5B490B087C3467B0F3043750438848461288BFEFD6198DD576DC3AD7A7CFA07DBA128C247A8EAB30DC3A30B02FCD7F1C8167965463626FEFF8AB1AA61A4B9AEF09EE12B009842A1ABA01ADB4A2B170668781EC92B60F605FD12B2B2A6F1FE734BE510F60DC5D189E401451B62B4E06851EC20EBFF4522AACC2E9CDC89BC5D8CDE5D633CFD77220FF6BBD4A9B441473CC3C6FEFC8D13E57C3DE97E1269FA19F655215B23563ED1D1860D8681DF040103DF0314874B379B7F607DC1CAF87A19E400B6A9E25163E8",
	"9F0605A0000000659F220114DF050420261231DF060101DF070101DF0281F8AEED55B9EE00E1ECEB045F61D2DA9A66AB637B43FB5CDBDB22A2FBB25BE061E937E38244EE5132F530144A3F268907D8FD648863F5A96FED7E42089E93457ADC0E1BC89C58A0DB72675FBC47FEE9FF33C16ADE6D341936B06B6A6F5EF6F66A4EDD981DF75DA8399C3053F430ECA342437C23AF423A211AC9F58EAF09B0F837DE9D86C7109DB1646561AA5AF0289AF5514AC64BC2D9D36A179BB8A7971E2BFA03A9E4B847FD3D63524D43A0E8003547B94A8A75E519DF3177D0A60BC0B4BAB1EA59A2CBB4D2D62354E926E9C7D3BE4181E81BA60F8285A896D17DA8C3242481B6C405769A39D547C74ED9FF95A70A796046B5EFF36682DC29DF040103DF0314C0D15F6CD957E491DB56DCDD1CA87A03EBE06B7B",
	"9F0605A0000000659F220111DF050420241231DF060101DF070101DF0281B0A2583AA40746E3A63C22478F576D1EFC5FB046135A6FC739E82B55035F71B09BEB566EDB9968DD649B94B6DEDC033899884E908C27BE1CD291E5436F762553297763DAA3B890D778C0F01E3344CECDFB3BA70D7E055B8C760D0179A403D6B55F2B3B083912B183ADB7927441BED3395A199EEFE0DEBD1F5FC3264033DA856F4A8B93916885BD42F9C1F456AAB8CFA83AC574833EB5E87BB9D4C006A4B5346BD9E17E139AB6552D9C58BC041195336485DF040103DF0314D9FD62C9DD4E6DE7741E9A17FB1FF2C5DB948BCB",
	"9F0605A0000000659F22010FDF050420241231DF060101DF070101DF0281909EFBADDE4071D4EF98C969EB32AF854864602E515D6501FDE576B310964A4F7C2CE842ABEFAFC5DC9E26A619BCF2614FE07375B9249BEFA09CFEE70232E75FFD647571280C76FFCA87511AD255B98A6B577591AF01D003BD6BF7E1FCE4DFD20D0D0297ED5ECA25DE261F37EFE9E175FB5F12D2503D8CFB060A63138511FE0E125CF3A643AFD7D66DCF9682BD246DDEA1DF040103DF03142A1B82DE00F5F0C401760ADF528228D3EDE0F403",
	"9F0605A0000001529F220103DF050420171231DF060101DF070101DF028190BF321241BDBF3585FFF2ACB89772EBD18F2C872159EAA4BC179FB03A1B850A1A758FA2C6849F48D4C4FF47E02A575FC13E8EB77AC37135030C5600369B5567D3A7AAF02015115E987E6BE566B4B4CC03A4E2B16CD9051667C2CD0EEF4D76D27A6F745E8BBEB45498ED8C30E2616DB4DBDA4BAF8D71990CDC22A8A387ACB21DD88E2CC27962B31FBD786BBB55F9E0B041DF040103DF0314CA1E9099327F0B786D8583EC2F27E57189503A57",
	"9F0605A0000001529F220104DF050420241231DF060101DF070101DF0281B08EEEC0D6D3857FD558285E49B623B109E6774E06E9476FE1B2FB273685B5A235E955810ADDB5CDCC2CB6E1A97A07089D7FDE0A548BDC622145CA2DE3C73D6B14F284B3DC1FA056FC0FB2818BCD7C852F0C97963169F01483CE1A63F0BF899D412AB67C5BBDC8B4F6FB9ABB57E95125363DBD8F5EBAA9B74ADB93202050341833DEE8E38D28BD175C83A6EA720C262682BEABEA8E955FE67BD9C2EFF7CB9A9F45DD5BDA4A1EEFB148BC44FFF68D9329FDDF040103DF031417F971CAF6B708E5B9165331FBA91593D0C0BF66",
	"9F0605A0000001529F220105DF050420241231DF060101DF070101DF0281F8E1200E9F4428EB71A526D6BB44C957F18F27B20BACE978061CCEF23532DBEBFAF654A149701C14E6A2A7C2ECAC4C92135BE3E9258331DDB0967C3D1D375B996F25B77811CCCC06A153B4CE6990A51A0258EA8437EDBEB701CB1F335993E3F48458BC1194BAD29BF683D5F3ECB984E31B7B9D2F6D947B39DEDE0279EE45B47F2F3D4EEEF93F9261F8F5A571AFBFB569C150370A78F6683D687CB677777B2E7ABEFCFC8F5F93501736997E8310EE0FD87AFAC5DA772BA277F88B44459FCA563555017CD0D66771437F8B6608AA1A665F88D846403E4C41AFEEDB9729C2B2511CFE228B50C1B152B2A60BBF61D8913E086210023A3AA499E423DF040103DF031412BCD407B6E627A750FDF629EE8C2C9CC7BA636A"
	};
	int capkListCount = sizeof(capkList) / sizeof(capkList[0]);


    PR_INT32 curAidCount = Emv_GetAidTotalNum();
    OsLog(LOG_ERROR,"curAidCount = %d \n",curAidCount);
    if(curAidCount < aidListCount){
		Emv_ClrAIDFile();
		for(int i = 0;i<aidListCount;i++){
			memset(temp,0x0,sizeof(temp));
			nAsc2Bcd(aidList[i], strlen(aidList[i]), temp, 0);
			if(Emv_PARAM_InputAIDData(temp,strlen(aidList[i])/2) <0){
				OsLog(LOG_ERROR,"Set AID Failed \n");
				return;
			}
		}       
    }

	int curCapkCount = Emv_GetCapkTotalNum();
    OsLog(LOG_ERROR,"curCapkCount = %d \n",curCapkCount);
    if(curCapkCount < capkListCount){
        Emv_ClrCAPKFile();
		for(int i = 0;i<capkListCount;i++){
			memset(temp,0x0,sizeof(temp));
			nAsc2Bcd(capkList[i], strlen(capkList[i]), temp, 0);
			if(Emv_PARAM_InputCAPKData(temp,strlen(capkList[i])/2) <0){
				OsLog(LOG_ERROR,"Set CAPK Failed \n");
				return;
			}
		}
    }

	curAidCount = Emv_GetAidTotalNum();
	curCapkCount = Emv_GetCapkTotalNum();
	OsLog(LOG_ERROR,"aidListCount = %d  capkListCount = %d \n",aidListCount,capkListCount);
	OsLog(LOG_ERROR,"curAidCount = %d  curCapkCount = %d \n",curAidCount,curCapkCount);
}

int pin_require_check( )
{
	uint i=0x0;
	unsigned char serviceCode[8] = {0};
	while(get_transaction_data()->sTracker2[i] != 0x3d){
 		i++;
	}
	i += 5;
	if(i + 3 <= get_transaction_data()->nTracker2Len){
		memcpy(serviceCode,&get_transaction_data()->sTracker2[i],3);
		if(serviceCode[0] == 0x31 || serviceCode[0] == 0x35 || serviceCode[0] == 0x37 || serviceCode[0] == 0x39)
		{
			if(serviceCode[2] == 0x30 || serviceCode[2] == 0x33 || serviceCode[2] == 0x35 || serviceCode[2] == 0x36 || serviceCode[2] == 0x37)
			{
				return 1;
			}
		}
	}
	
	return 0;
}

int swipcard_process(){
	int ret;
	EmvOnlineData_t pOnlineData;
	memset(&pOnlineData,0x0,sizeof(EmvOnlineData_t));

	do
	{
		if(pin_require_check() == 1)
		{
			get_transaction_data()->emv_emter_online_pin_result =0xFF;
			event_ui_register(UI_ENTER_ONLINE_PIN);
			ret = OsPedOpen();
			if(ret != RET_OK)
			{
				break;
			}

			ret = OsPedIncreaseKsnDukpt(PED_PIN_IPEK_INDEX);
			if(ret != RET_OK){
				OsCloseSoftKeyboard ();
				break;
			}
			ret = OsPedGetPinBlockDukptBySoftKeyboard(PED_PIN_IPEK_INDEX,get_transaction_data()->sCardNo, 4, 6, 60*1000,get_transaction_data()->sPinKsn, get_transaction_data()->sPin,disp_mask_pin);
			OsLog(LOG_DEBUG,"--------online pin enter ret = %d ",ret);
			OsCloseSoftKeyboard ();
			if(ret != RET_OK)
				break;

			get_transaction_data()->emv_emter_online_pin_result = 1;
		}

		event_ui_register(UI_PROCESSING);
		ret = sale_online_request(&pOnlineData);

	}while(0);

	return ret;
}